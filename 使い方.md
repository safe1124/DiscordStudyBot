# 📚 勉強時間記録Bot 使い方ガイド

## 🎯 概要

このDiscord Botは、勉強時間を自動で記録・管理し、メンバー間でランキングを競い合えるツールです。
音声チャンネルでの自動追跡機能とスラッシュコマンドによる手動記録の両方に対応しています。

---

## 🔧 初期設定

### 必要な環境
- Node.js (v16以上推奨)
- Discord Bot Token
- SQLite3

### セットアップ手順

1. **依存関係のインストール**
```bash
npm install
```

2. **環境変数の設定**
`.env`ファイルを作成し、以下を記入：
```
DISCORD_TOKEN=あなたのボットトークン
```

3. **Botの起動**
```bash
node index.js
```

4. **Discord Developer Portalでの設定**
   - Bot → Intents → **Server Members Intent** を有効化（オプション）
   - Bot → Intents → **Voice States Intent** を有効化（必須）

---

## 📱 機能一覧

### 1️⃣ 音声チャンネル自動追跡（推奨）

#### 🎙️ 自動記録の仕組み
- **対象チャンネル**: 名前に「study」を含む音声チャンネル（例：StudyRoom1, studyroom, Study Hallなど）
- **入場時**: 自動で勉強開始時刻を記録
- **退場時**: 自動で勉強時間を計算・保存し、`#入退室管理`チャンネルに通知

#### 📊 通知内容
**入場通知**:
```
📱 入場
@ユーザー名 がstudyroomに入場しました
```

**退場通知**:
```
📵 退出
@ユーザー名 がstudyroomから退出しました
勉強時間: 45分（約0時間45分）
```

#### ⚠️ 注意事項
- study系チャンネル間の移動（StudyRoom1 → StudyRoom2）は記録されません
- 最低記録時間: 1分以上

---

### 2️⃣ スラッシュコマンド

#### 📚 勉強記録コマンド

##### `/startstudy`
勉強を開始します。

**使い方**:
```
/startstudy
```

**機能**:
- 勉強開始時刻を記録
- 一時停止中の場合は再開
- すでに勉強中の場合はエラーメッセージを表示

---

##### `/pausestudy`
勉強を一時停止します。

**使い方**:
```
/pausestudy
```

**機能**:
- 現在の勉強時間を累積
- セッションは継続（`/startstudy`で再開可能）

---

##### `/stopstudy`
勉強セッションを終了し、データベースに保存します。

**使い方**:
```
/stopstudy
```

**機能**:
- 勉強時間をDBに保存
- 今日の累計勉強時間を表示
- セッションをリセット

---

#### 📊 統計・ランキングコマンド

##### `/stats`
あなたの個人統計を表示します。

**使い方**:
```
/stats
```

**表示内容**:
- 今日の勉強時間
- 今週（ISO週）の勉強時間
- 今月の勉強時間

**例**:
```
学習記録（あなた）
Asia/Seoul時間で集計しています。

今日: 120分（約2時間0分）
今週(ISO): 450分（約7時間30分）
今月: 1800分（約30時間0分）
```

---

##### `/rank`
月間勉強時間別ティアランキングを表示します。

**使い方**:
```
/rank
```

**ティアシステム**:
| ティア | 必要時間 | アイコン |
|--------|----------|----------|
| チャレンジャー | 70時間以上 | 🔥 |
| グランドマスター | 60時間以上 | 👑 |
| マスター | 50時間以上 | ⭐ |
| ダイヤモンド | 40時間以上 | 💎 |
| プラチナ | 30時間以上 | 🤍 |
| ゴールド | 20時間以上 | 🏆 |
| シルバー | 10時間以上 | 🥈 |
| ブロンズ | 5時間以上 | 🥉 |
| ノービス | 5時間未満 | 🌱 |

**表示例**:
```
今月の勉強ティアランキング 📊
2025-01 の月間勉強時間に基づくティアランキング

ティア別ランキング
**チャレンジャー 🔥** - @太郎：4500分（約75時間0分）
**ダイヤモンド 💎** - @花子：2700分（約45時間0分）
**ゴールド 🏆** - @次郎：1350分（約22時間30分）
```

---

##### `/globalstats`
全員分の勉強時間統計を表示します（上位5名）。

**使い方**:
```
/globalstats
```

**表示内容**:
- 今日のトップ5
- 今週のトップ5
- 今月のトップ5

---

#### ✅ ToDoリスト管理コマンド

##### `/todoadd <内容>`
新しいToDoを追加します。

**使い方**:
```
/todoadd content:数学の宿題を終わらせる
```

**パラメータ**:
- `content`: ToDoの内容（最大200文字）

---

##### `/todolist`
現在のToDo一覧を表示します（最大10件）。

**使い方**:
```
/todolist
```

**表示例**:
```
ToDo一覧 (最大10件)

1. ⬜ 未完了 - 数学の宿題を終わらせる
2. ✅ 完了 - 英語の単語を覚える
3. ⬜ 未完了 - プログラミング課題を提出
```

---

##### `/todocomplete <番号>`
指定番号のToDoを完了にします。

**使い方**:
```
/todocomplete number:1
```

**パラメータ**:
- `number`: `/todolist`で表示された番号

---

##### `/tododelete <番号>`
指定番号のToDoを削除します。

**使い方**:
```
/tododelete number:1
```

**パラメータ**:
- `number`: `/todolist`で表示された番号

---

##### `/task @ユーザー`
他のユーザーのToDoリストを表示します。

**使い方**:
```
/task user:@太郎
```

**機能**:
- チームメンバーの進捗確認
- 協力作業の調整

---

## 🏗️ システム構成

### データベース構造

#### `study_records` テーブル
勉強記録を保存します。

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| user_id | TEXT | DiscordユーザーID |
| start_time | TEXT | 開始時刻（ISO 8601） |
| end_time | TEXT | 終了時刻（ISO 8601） |
| total_minutes | INTEGER | 勉強時間（分） |
| date | TEXT | 日付キー（YYYY-MM-DD） |
| week | TEXT | 週キー（YYYY-Wxx） |
| month | TEXT | 月キー（YYYY-MM） |

#### `todos` テーブル
ToDoリストを保存します。

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| user_id | TEXT | DiscordユーザーID |
| task | TEXT | タスク内容 |
| completed | INTEGER | 完了フラグ（0/1） |
| created_at | TEXT | 作成日時（ISO 8601） |

---

## ⏰ タイムゾーン設定

- **デフォルト**: Asia/Seoul (UTC+9)
- すべての統計はこのタイムゾーンで集計されます

---

## 🔍 トラブルシューティング

### Bot が応答しない場合

1. **Botが起動しているか確認**
```bash
ps aux | grep "node index.js"
```

2. **ログを確認**
```bash
tail -f bot.log
```

3. **Botを再起動**
```bash
pkill -f "node index.js"
node index.js
```

---

### 音声チャンネル追跡が動作しない場合

1. **Discord Developer Portalで確認**
   - Bot → Intents → **Voice States Intent** が有効化されているか確認

2. **チャンネル名を確認**
   - 音声チャンネル名に「study」が含まれているか確認（大文字小文字は無関係）

3. **管理チャンネルの存在確認**
   - `#入退室管理` という名前のテキストチャンネルが存在するか確認
   - Botがそのチャンネルにメッセージを送信する権限があるか確認

---

### コマンドが「アプリケーションが応答しませんでした」と表示される場合

1. **Botを再起動**（コマンドキャッシュをクリア）
```bash
pkill -f "node index.js"
node index.js
```

2. **Discord側でコマンドを再読み込み**
   - Discordを再起動
   - スラッシュコマンド入力時に候補が表示されるまで待つ

---

## 📝 よくある質問（FAQ）

### Q1: 音声チャンネルにいる間、ずっと記録されますか？
**A**: はい。study系チャンネルに入場してから退場するまでの時間が自動で記録されます。

### Q2: 複数のstudy系チャンネルがある場合は？
**A**: どのstudy系チャンネルでも記録されます。チャンネル間の移動は無視され、最初の入場から最後の退場までの時間が記録されます。

### Q3: 手動コマンドと音声チャンネル追跡は併用できますか？
**A**: はい。ただし、音声チャンネル追跡の方が便利なので、基本的には音声チャンネルの使用を推奨します。

### Q4: 過去の記録を修正できますか？
**A**: 現在のバージョンでは対応していません。データベースを直接編集する必要があります。

### Q5: ランキングはいつリセットされますか？
**A**: 月ごとに自動でリセットされます（毎月1日）。

### Q6: ToDoリストは他の人に見られますか？
**A**: `/task @ユーザー名` コマンドを使えば、他の人のToDoリストを閲覧できます。

---

## 🎨 カスタマイズ

### タイムゾーンの変更
`index.js` の14行目を編集：
```javascript
const TIMEZONE = 'Asia/Tokyo'; // 例：日本時間に変更
```

### 対象チャンネル名の変更
`index.js` の190行目を編集：
```javascript
const STUDY_ROOM_NAME = 'studyroom'; // 任意の名前に変更
```

### 管理チャンネル名の変更
`index.js` の191行目を編集：
```javascript
const MANAGEMENT_CHANNEL_NAME = '入退室管理'; // 任意の名前に変更
```

### ティアシステムのカスタマイズ
`index.js` の19-32行目の `getTierByMinutes` 関数を編集：
```javascript
function getTierByMinutes(minutes) {
  const safeMinutes = Math.max(Number(minutes) || 0, 0);
  
  if (safeMinutes >= 70 * 60) return 'チャレンジャー 🔥';
  // ... 他のティアを追加・変更
}
```

---

## 📞 サポート

問題が発生した場合は、以下の情報を含めて報告してください：

1. エラーメッセージ（あれば）
2. 実行したコマンド
3. `bot.log` の最新ログ
4. Node.jsのバージョン（`node -v`）
5. Discord.jsのバージョン（`package.json`を確認）

---

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

---

## 🙏 謝辞

このBotを使用してくださりありがとうございます！
勉強を頑張ってください！💪📚

---

**最終更新**: 2025年1月
**バージョン**: 2.0.0

